app:
  description: ''
  icon: ü§ñ
  icon_background: '#FFEAD5'
  mode: advanced-chat
  name: Medical Scribe (GDG Devfest)
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.6.4@17f286b2d6699a258a2eba8bc1bff71b8f795b6aa7bee1464cbfa450b451303a
    version: null
kind: app
version: 0.4.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5000
        file_size_limit: 100
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInLoop: false
        sourceType: start
        targetType: llm
      id: 1763799922966-source-llm-target
      selected: false
      source: '1763799922966'
      sourceHandle: source
      target: llm
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: if-else
      id: llm-source-1763800904244-target
      selected: false
      source: llm
      sourceHandle: source
      target: '1763800904244'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: 1763800904244-true-answer-target
      selected: false
      source: '1763800904244'
      sourceHandle: 'true'
      target: answer
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: if-else
      id: 1763800904244-false-1763801237188-target
      selected: false
      source: '1763800904244'
      sourceHandle: 'false'
      target: '1763801237188'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: tool
      id: 1763801237188-true-1763801590027-target
      selected: false
      source: '1763801237188'
      sourceHandle: 'true'
      target: '1763801590027'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: tool
        targetType: template-transform
      id: 1763801590027-source-1763802817213-target
      selected: false
      source: '1763801590027'
      sourceHandle: source
      target: '1763802817213'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: template-transform
        targetType: llm
      id: 1763802817213-source-1763801795791-target
      selected: false
      source: '1763802817213'
      sourceHandle: source
      target: '1763801795791'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: template-transform
      id: 1763801237188-false-1763802817213-target
      selected: false
      source: '1763801237188'
      sourceHandle: 'false'
      target: '1763802817213'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1763801795791-source-1763802945681-target
      selected: false
      source: '1763801795791'
      sourceHandle: source
      target: '1763802945681'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1763802945681-source-1763803754384-target
      selected: false
      source: '1763802945681'
      sourceHandle: source
      target: '1763803754384'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: template-transform
      id: 1763803836243-source-1763804168711-target
      selected: false
      source: '1763803836243'
      sourceHandle: source
      target: '1763804168711'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: template-transform
        targetType: answer
      id: 1763804168711-source-1763804449838-target
      selected: false
      source: '1763804168711'
      sourceHandle: source
      target: '1763804449838'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1763803754384-source-1763808107990-target
      selected: false
      source: '1763803754384'
      sourceHandle: source
      target: '1763808107990'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1763808107990-source-1763811812908-target
      selected: false
      source: '1763808107990'
      sourceHandle: source
      target: '1763811812908'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: template-transform
      id: 1763812453361-source-1763812737094-target
      selected: false
      source: '1763812453361'
      sourceHandle: source
      target: '1763812737094'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: template-transform
        targetType: llm
      id: 1763812737094-source-1763803836243-target
      selected: false
      source: '1763812737094'
      sourceHandle: source
      target: '1763803836243'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: knowledge-retrieval
      id: 1763811812908-source-1763823575062-target
      selected: false
      source: '1763811812908'
      sourceHandle: source
      target: '1763823575062'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: knowledge-retrieval
      id: 1763811812908-source-1763823618307-target
      selected: false
      source: '1763811812908'
      sourceHandle: source
      target: '1763823618307'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: knowledge-retrieval
      id: 1763811812908-source-1763823646400-target
      selected: false
      source: '1763811812908'
      sourceHandle: source
      target: '1763823646400'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: knowledge-retrieval
      id: 1763811812908-source-1763823674800-target
      selected: false
      source: '1763811812908'
      sourceHandle: source
      target: '1763823674800'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: knowledge-retrieval
      id: 1763811812908-source-1763823697319-target
      selected: false
      source: '1763811812908'
      sourceHandle: source
      target: '1763823697319'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: template-transform
      id: 1763823646400-source-1763828512463-target
      selected: false
      source: '1763823646400'
      sourceHandle: source
      target: '1763828512463'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: template-transform
      id: 1763823575062-source-1763828512463-target
      selected: false
      source: '1763823575062'
      sourceHandle: source
      target: '1763828512463'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: template-transform
      id: 1763823618307-source-1763828512463-target
      selected: false
      source: '1763823618307'
      sourceHandle: source
      target: '1763828512463'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: template-transform
      id: 1763823674800-source-1763828512463-target
      selected: false
      source: '1763823674800'
      sourceHandle: source
      target: '1763828512463'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: template-transform
      id: 1763823697319-source-1763828512463-target
      selected: false
      source: '1763823697319'
      sourceHandle: source
      target: '1763828512463'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: template-transform
        targetType: llm
      id: 1763828512463-source-1763812453361-target
      source: '1763828512463'
      sourceHandle: source
      target: '1763812453361'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: Start
        type: start
        variables:
        - default: ''
          hint: ''
          label: M√¥ t·∫£ ca / ghi ch√∫ cho CLARA
          max_length: 256
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: case_description
        - allowed_file_extensions: []
          allowed_file_types:
          - audio
          - video
          allowed_file_upload_methods:
          - local_file
          - remote_url
          default: ''
          hint: ''
          label: visit_audio
          max_length: 5
          options: []
          placeholder: ''
          required: false
          type: file-list
          variable: visit_audio
      height: 113
      id: '1763799922966'
      position:
        x: 30
        y: 386
      positionAbsolute:
        x: 30
        y: 386
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763799922966'
          - case_description
        memory:
          query_prompt_template: '{{#sys.query#}}


            {{#sys.files#}}'
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 10
        model:
          completion_params:
            json_schema: "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"\
              is_medical_context\": {\n      \"type\": \"boolean\",\n      \"description\"\
              : \"true n·∫øu ƒë√¢y l√† n·ªôi dung li√™n quan kh√°m b·ªánh, h·ªèi b·ªánh, ca l√¢m s√†ng,\
              \ m√¥ ph·ªèng y khoa.\"\n    },\n    \"language\": {\n      \"type\": \"\
              string\",\n      \"description\": \"Ng√¥n ng·ªØ ch√≠nh: vi, en, ho·∫∑c mixed.\"\
              ,\n      \"enum\": [\n        \"vi\",\n        \"en\",\n        \"mixed\"\
              ,\n        \"unknown\"\n      ]\n    },\n    \"has_audio\": {\n    \
              \  \"type\": \"boolean\",\n      \"description\": \"true n·∫øu workflow\
              \ nh·∫≠n ƒë∆∞·ª£c file audio; n·∫øu kh√¥ng ch·∫Øc th√¨ d√πng gi√° tr·ªã truy·ªÅn v√†o.\"\
              \n    },\n    \"note\": {\n      \"type\": \"string\",\n      \"description\"\
              : \"Gi·∫£i th√≠ch ng·∫Øn c√°ch b·∫°n ph√¢n lo·∫°i.\"\n    }\n  },\n  \"required\"\
              : [\n    \"is_medical_context\",\n    \"language\",\n    \"has_audio\"\
              \n  ]\n}"
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 3e28c313-0706-484b-b391-4700f230c38e
          role: system
          text: 'B·∫°n l√† b·ªô ph√¢n lo·∫°i input cho h·ªá th·ªëng ghi ch√©p y khoa CLARA Medical
            Scribe.

            Nhi·ªám v·ª•:

            X√°c ƒë·ªãnh xem n·ªôi dung ng∆∞·ªùi d√πng cung c·∫•p c√≥ li√™n quan ƒë·∫øn h·ªôi tho·∫°i /
            ca l√¢m s√†ng hay kh√¥ng (is_medical_context=true) {{#sys.query#}} ho·∫∑c {{#context#}}.

            ƒêo√°n ng√¥n ng·ªØ ch√≠nh: ti·∫øng Vi·ªát hay ti·∫øng Anh.

            Ghi nh·∫≠n vi·ªác c√≥ file audio hay kh√¥ng (do h·ªá th·ªëng cung c·∫•p).

            has_audio = true n·∫øu {{#1763799922966.visit_audio#}} kh√¥ng r·ªóng, c√≤n l·∫°i
            false

            Tr·∫£ v·ªÅ DUY NH·∫§T 1 JSON ƒë√∫ng schema ƒë√£ c·∫•u h√¨nh.'
        - id: 12d4a0a6-6b57-4e38-abd9-954024a7726b
          role: user
          text: 'User query:

            {{#sys.query#}}


            Context:

            {{#1763799922966.case_description#}}


            Audio:

            {{#1763799922966.visit_audio#}}'
        selected: false
        structured_output:
          schema:
            properties:
              has_audio:
                description: true n·∫øu workflow nh·∫≠n ƒë∆∞·ª£c file audio; n·∫øu kh√¥ng ch·∫Øc
                  th√¨ d√πng gi√° tr·ªã truy·ªÅn v√†o.
                type: boolean
              is_medical_context:
                description: true n·∫øu ƒë√¢y l√† n·ªôi dung li√™n quan kh√°m b·ªánh, h·ªèi b·ªánh,
                  ca l√¢m s√†ng, m√¥ ph·ªèng y khoa.
                type: boolean
              language:
                description: 'Ng√¥n ng·ªØ ch√≠nh: vi, en, ho·∫∑c mixed.'
                enum:
                - vi
                - en
                - mixed
                - unknown
                type: string
              note:
                description: Gi·∫£i th√≠ch ng·∫Øn c√°ch b·∫°n ph√¢n lo·∫°i.
                type: string
            required:
            - is_medical_context
            - language
            - has_audio
            type: object
        structured_output_enabled: true
        title: Input_Classifier
        type: llm
        vision:
          enabled: false
      height: 87
      id: llm
      position:
        x: 360.7057887053794
        y: 386
      positionAbsolute:
        x: 360.7057887053794
        y: 386
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: CLARA ch·ªâ x·ª≠ l√Ω n·ªôi dung y khoa / ca l√¢m s√†ng.
        selected: false
        title: ANSWER_NotMedical
        type: answer
        variables: []
      height: 115
      id: answer
      position:
        x: 1117
        y: 258
      positionAbsolute:
        x: 1117
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            id: b74c9075-e73f-416d-9bd0-d0e8a67b81f3
            value: 'false'
            varType: object
            variable_selector:
            - llm
            - structured_output
            - is_medical_context
          id: 'true'
          logical_operator: and
        selected: false
        title: IF/ELSE
        type: if-else
      height: 123
      id: '1763800904244'
      position:
        x: 694
        y: 386
      positionAbsolute:
        x: 694
        y: 386
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: not empty
            id: 938c1abe-1196-411c-8100-6a69300c137a
            value: ''
            varType: array[file]
            variable_selector:
            - '1763799922966'
            - visit_audio
          id: 'true'
          logical_operator: and
        selected: false
        title: IF_HasAudio
        type: if-else
      height: 123
      id: '1763801237188'
      position:
        x: 1449
        y: 406
      positionAbsolute:
        x: 1449
        y: 406
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        is_team_authorization: true
        paramSchemas:
        - auto_generate: null
          default: Bearer sk-McyM7OGluespwyk9XJW3HWHXjp0oheXg42xbEZflho95v50v
          form: llm
          human_description:
            en_US: API key for Yescale / OpenAI. Hard-coded default.
            ja_JP: API key for Yescale / OpenAI. Hard-coded default.
            pt_BR: API key for Yescale / OpenAI. Hard-coded default.
            zh_Hans: API key for Yescale / OpenAI. Hard-coded default.
          label:
            en_US: Authorization
            ja_JP: Authorization
            pt_BR: Authorization
            zh_Hans: Authorization
          llm_description: API key for Yescale / OpenAI. Hard-coded default.
          max: null
          min: null
          name: Authorization
          options: []
          placeholder:
            en_US: API key for Yescale / OpenAI. Hard-coded default.
            ja_JP: API key for Yescale / OpenAI. Hard-coded default.
            pt_BR: API key for Yescale / OpenAI. Hard-coded default.
            zh_Hans: API key for Yescale / OpenAI. Hard-coded default.
          precision: null
          required: true
          scope: null
          template: null
          type: string
        - auto_generate: null
          default: null
          form: llm
          human_description:
            en_US: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            ja_JP: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            pt_BR: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            zh_Hans: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
          label:
            en_US: file
            ja_JP: file
            pt_BR: file
            zh_Hans: file
          llm_description: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav,
            webm).
          max: null
          min: null
          name: file
          options: []
          placeholder:
            en_US: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            ja_JP: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            pt_BR: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
            zh_Hans: Audio file (flac, mp3, mp4, mpeg, mpga, m4a, ogg, wav, webm).
          precision: null
          required: true
          scope: null
          template: null
          type: file
        - auto_generate: null
          default: null
          form: llm
          human_description:
            en_US: STT model id.
            ja_JP: STT model id.
            pt_BR: STT model id.
            zh_Hans: STT model id.
          label:
            en_US: model
            ja_JP: model
            pt_BR: model
            zh_Hans: model
          llm_description: STT model id.
          max: null
          min: null
          name: model
          options: []
          placeholder:
            en_US: STT model id.
            ja_JP: STT model id.
            pt_BR: STT model id.
            zh_Hans: STT model id.
          precision: null
          required: true
          scope: null
          template: null
          type: string
        - auto_generate: null
          default: null
          form: llm
          human_description:
            en_US: Optional text prompt to guide the transcription style (same language
              as audio).
            ja_JP: Optional text prompt to guide the transcription style (same language
              as audio).
            pt_BR: Optional text prompt to guide the transcription style (same language
              as audio).
            zh_Hans: Optional text prompt to guide the transcription style (same language
              as audio).
          label:
            en_US: prompt
            ja_JP: prompt
            pt_BR: prompt
            zh_Hans: prompt
          llm_description: Optional text prompt to guide the transcription style (same
            language as audio).
          max: null
          min: null
          name: prompt
          options: []
          placeholder:
            en_US: Optional text prompt to guide the transcription style (same language
              as audio).
            ja_JP: Optional text prompt to guide the transcription style (same language
              as audio).
            pt_BR: Optional text prompt to guide the transcription style (same language
              as audio).
            zh_Hans: Optional text prompt to guide the transcription style (same language
              as audio).
          precision: null
          required: false
          scope: null
          template: null
          type: string
        params:
          Authorization: ''
          file: ''
          model: ''
          prompt: ''
        provider_id: e0a1121a-7aa1-4cbb-834a-eb43fe9d46b8
        provider_name: TranscribeAudio
        provider_type: api
        selected: false
        title: TranscribeAudio
        tool_configurations: {}
        tool_description: Uploads an audio file and returns the transcription text.
        tool_label: TranscribeAudio
        tool_name: TranscribeAudio
        tool_node_version: '2'
        tool_parameters:
          Authorization:
            type: mixed
            value: Bearer sk-McyM7OGluespwyk9XJW3HWHXjp0oheXg42xbEZflho95v50v
          file:
            type: variable
            value:
            - '1763799922966'
            - visit_audio
          model:
            type: mixed
            value: gpt-4o-mini-transcribe
          prompt:
            type: mixed
            value: ''
        type: tool
      height: 51
      id: '1763801590027'
      position:
        x: 1872
        y: 258
      positionAbsolute:
        x: 1872
        y: 258
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763802817213'
          - output
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: c7337803-18bd-4d61-9962-23cf77bfa33e
          role: system
          text: "Transcript th√¥ (t·ª´ ASR / STT):\n\n{{#1763802817213.output#}}\n\n\
            B·∫°n l√† module `TRANSCRIPT_NORMALIZER` trong h·ªá th·ªëng CLARA Medical Scribe,\
            \ chuy√™n x·ª≠ l√Ω transcript h·ªôi tho·∫°i b√°c sƒ© ‚Äì b·ªánh nh√¢n b·∫±ng ti·∫øng Vi·ªát.\n\
            \nNhi·ªám v·ª•:\n\n1. Chu·∫©n h√≥a transcript:\n   - Th√™m d·∫•u c√¢u, xu·ªëng d√≤ng\
            \ h·ª£p l√Ω.\n   - S·ª≠a c√°c l·ªói ch√≠nh t·∫£ r√µ r√†ng (v√≠ d·ª•: \"ti·ªÉu ƒëu√≤ng\" ‚Üí\
            \ \"ti·ªÉu ƒë∆∞·ªùng\", \"ap\" ‚Üí \"√°p\"), nh∆∞ng KH√îNG thay ƒë·ªïi √Ω nghƒ©a n·ªôi dung.\n\
            \n2. T√°ch cu·ªôc h·ªôi tho·∫°i th√†nh c√°c l∆∞·ª£t tho·∫°i (turn) theo ƒë√∫ng tr√¨nh t·ª±\
            \ th·ªùi gian v√† g√°n nh√£n speaker:\n   - `\"BS\"` = b√°c sƒ© ho·∫∑c nh√¢n vi√™n\
            \ y t·∫ø.\n   - `\"BN\"` = b·ªánh nh√¢n.\n   - `\"KHAC\"` = ng∆∞·ªùi nh√† ho·∫∑c\
            \ ng∆∞·ªùi kh√°c (kh√¥ng ph·∫£i b√°c sƒ©/b·ªánh nh√¢n).\n   - Ph√¢n lo·∫°i:\n     - C√¢u\
            \ h·ªèi chuy√™n m√¥n, gi·∫£i th√≠ch, ch·ªâ ƒë·ªãnh ‚Üí th∆∞·ªùng l√† \"BS\".\n     - C√¢u\
            \ tr·∫£ l·ªùi v·ªÅ tri·ªáu ch·ª©ng, ti·ªÅn s·ª≠, th√≥i quen, lo l·∫Øng ‚Üí th∆∞·ªùng l√† \"BN\"\
            .\n\n3. M·ªói l∆∞·ª£t tho·∫°i (turn):\n   - Ch·ªâ thu·ªôc v·ªÅ m·ªôt ng∆∞·ªùi.\n   - C√≥\
            \ hai tr∆∞·ªùng:\n     - `speaker`: m·ªôt trong `\"BS\"`, `\"BN\"`, `\"KHAC\"\
            `.\n     - `utterance`: ƒëo·∫°n l·ªùi n√≥i ƒë√£ chu·∫©n h√≥a (ƒë√£ c√≥ d·∫•u c√¢u ph√π h·ª£p).\n\
            \n4. Ngo√†i m·∫£ng `turns`, t·∫°o th√™m m·ªôt tr∆∞·ªùng:\n   - `normalized_transcript`:\
            \ m·ªôt chu·ªói (string) ch·ª©a to√†n b·ªô h·ªôi tho·∫°i ƒë√£ chu·∫©n h√≥a (c√πng ng√¥n ng·ªØ,\
            \ ƒë·∫ßy ƒë·ªß n·ªôi dung).\n\nR√†ng bu·ªôc b·∫Øt bu·ªôc:\n\n- KH√îNG ƒë∆∞·ª£c th√™m n·ªôi dung\
            \ y khoa m·ªõi.\n- KH√îNG t√≥m t·∫Øt, KH√îNG r√∫t g·ªçn n·ªôi dung.\n- KH√îNG d·ªãch\
            \ sang ng√¥n ng·ªØ kh√°c (gi·ªØ nguy√™n ti·∫øng Vi·ªát).\n- KH√îNG tr·∫£ v·ªÅ JSON schema,\
            \ KH√îNG m√¥ t·∫£ schema.\n- KH√îNG d√πng c√°c key nh∆∞ `\"type\"`, `\"properties\"\
            `, `\"required\"`, `\"description\"` ·ªü c·∫•p cao nh·∫•t.\n- Ch·ªâ tr·∫£ v·ªÅ M·ªòT\
            \ ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t"
        - id: a7d1a24a-7810-43ae-adcb-3a46c9919f79
          role: user
          text: 'Transcript th√¥:

            {{#context#}}

            '
        selected: false
        structured_output:
          schema:
            properties:
              normalized_transcript:
                type: string
              turns:
                items:
                  properties:
                    speaker:
                      enum:
                      - BS
                      - BN
                      - KHAC
                      type: string
                    utterance:
                      type: string
                  required:
                  - speaker
                  - utterance
                  type: object
                type: array
            required:
            - normalized_transcript
            - turns
            type: object
        structured_output_enabled: true
        title: Transcript_Normalizer
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763801795791'
      position:
        x: 2536
        y: 258
      positionAbsolute:
        x: 2536
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        selected: false
        template: "{{ arg1 }}\r\n{{ arg2 }}"
        title: Transcript
        type: template-transform
        variables:
        - value_selector:
          - '1763801590027'
          - text
          value_type: string
          variable: arg1
        - value_selector:
          - sys
          - query
          value_type: string
          variable: arg2
      height: 51
      id: '1763802817213'
      position:
        x: 2204
        y: 258
      positionAbsolute:
        x: 2204
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763801795791'
          - structured_output
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 2e1e9e28-1d95-46b5-af09-98678049d417
          role: system
          text: "B·∫°n l√† module ·∫©n danh h√≥a (de-identification) cho transcript h·ªôi\
            \ tho·∫°i y khoa.\n\nNg·ªØ c·∫£nh ƒë·∫ßu v√†o l√† {{#1763801795791.structured_output#}}\
            \ JSON c√≥ d·∫°ng:\n{\n  \"normalized_transcript\": string,  // to√†n b·ªô h·ªôi\
            \ tho·∫°i ƒë√£ chu·∫©n ho√°\n  \"turns\": [\n    { \"speaker\": \"BN\" | \"BS\"\
            \ | \"KHAC\", \"utterance\": string },\n    ...\n  ]\n}\n\nNhi·ªám v·ª• c·ªßa\
            \ b·∫°n:\n- Gi·ªØ nguy√™n c·∫•u tr√∫c JSON (c√°c field v√† m·∫£ng y nh∆∞ ƒë·∫ßu v√†o).\n\
            - Ch·ªâ s·ª≠a N·ªòI DUNG CHU·ªñI (string) ƒë·ªÉ ·∫©n danh:\n  - T√™n ri√™ng b·ªánh nh√¢n,\
            \ b√°c sƒ©, ng∆∞·ªùi nh√†.\n  - S·ªë ƒëi·ªán tho·∫°i, email, ƒë·ªãa ch·ªâ c·ª• th·ªÉ, s·ªë h·ªì\
            \ s∆° b·ªánh √°n, m√£ ƒë·ªãnh danh c√° nh√¢n (CMND/CCCD, BHYT...).\n  - T√™n b·ªánh\
            \ vi·ªán/ph√≤ng kh√°m qu√° c·ª• th·ªÉ, n·∫øu c√≥.\n- Thay c√°c th√¥ng tin ƒë√≥ b·∫±ng chu·ªói\
            \ \"[REDACTED]\".\n- Tuy·ªát ƒë·ªëi kh√¥ng xo√°, kh√¥ng th√™m m·ªõi th√¥ng tin l√¢m\
            \ s√†ng (tri·ªáu ch·ª©ng, di·ªÖn ti·∫øn, ch·∫©n ƒëo√°n...).\n- Kh√¥ng t√≥m t·∫Øt, kh√¥ng\
            \ d·ªãch sang ng√¥n ng·ªØ kh√°c.\n\nQUAN TR·ªåNG:\n- ƒê·∫ßu ra ph·∫£i l√† M·ªòT JSON OBJECT\
            \ DUY NH·∫§T, ph√π h·ª£p v·ªõi JSON Schema ƒë√£ c·∫•u h√¨nh trong Structured Output.\n\
            - KH√îNG ƒë∆∞·ª£c in l·∫°i JSON Schema, KH√îNG th√™m tr∆∞·ªùng \"type\", \"properties\"\
            , \"required\" ·ªü level g·ªëc.\n- V√≠ d·ª• d·∫°ng ƒë·∫ßu ra (minh ho·∫°):\n  {\n  \
            \  \"normalized_transcript\": \"BN: [REDACTED], d·∫°o n√†y em hay ƒëau ng·ª±c...\"\
            ,\n    \"turns\": [\n      { \"speaker\": \"BN\", \"utterance\": \"Ch√†o\
            \ b√°c sƒ©, em l√† [REDACTED]...\" },\n      { \"speaker\": \"BS\", \"utterance\"\
            : \"Em m√¥ t·∫£ r√µ h∆°n c∆°n ƒëau gi√∫p b√°c sƒ© nh√©.\" }\n    ]\n  }\nCh·ªâ tr·∫£\
            \ v·ªÅ JSON, kh√¥ng gi·∫£i th√≠ch th√™m.\n"
        - id: eb16e5ee-001f-4ca9-b7d3-25d0f71d98aa
          role: user
          text: 'Transcript chu·∫©n h√≥a: {{#context#}}'
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              allergies:
                description: D·ªã ·ª©ng thu·ªëc/th·ª©c ƒÉn, d·∫°ng list text ƒë√£ ·∫©n danh.
                items:
                  type: string
                type: array
              assessment:
                description: 'Assessment: list problem + impression.'
                items:
                  additionalProperties: false
                  properties:
                    impression:
                      description: Nh·∫≠n ƒë·ªãnh/gi·∫£i th√≠ch chi ti·∫øt h∆°n.
                      type: string
                    problem:
                      description: V·∫•n ƒë·ªÅ/ch·∫©n ƒëo√°n t√≥m t·∫Øt.
                      type: string
                  required:
                  - problem
                  - impression
                  type: object
                type: array
              chief_complaint:
                description: L√Ω do v√†o kh√°m / tri·ªáu ch·ª©ng ch√≠nh, ƒë√£ ƒë∆∞·ª£c ·∫©n danh n·∫øu
                  c√≥ PII.
                type: string
              family_history:
                description: Ti·ªÅn s·ª≠ gia ƒë√¨nh (b·ªánh tim m·∫°ch, ƒêTƒê, ƒë·ªôt qu·ªµ...), ƒë√£
                  ·∫©n danh.
                type: string
              history_of_present_illness:
                description: Di·ªÖn ti·∫øn b·ªánh hi·ªán t·∫°i (HPI), ƒë√£ ·∫©n danh.
                type: string
              labs_and_imaging:
                description: Th√¥ng tin c·∫≠n l√¢m s√†ng (x√©t nghi·ªám, ECG, si√™u √¢m, CT...),
                  ƒë√£ ·∫©n danh.
                type: string
              medications:
                description: Thu·ªëc ƒëang d√πng, m·ªói ph·∫ßn t·ª≠ l√† 1 thu·ªëc.
                items:
                  additionalProperties: false
                  properties:
                    dose:
                      description: 'Li·ªÅu thu·ªëc, d·∫°ng text t·ª± do (v√≠ d·ª•: 5mg, 1 vi√™n...).'
                      type: string
                    frequency:
                      description: 'S·ªë l·∫ßn/l·ªãch d√πng (v√≠ d·ª•: 1 l·∫ßn/ng√†y, s√°ng/t·ªëi...).'
                      type: string
                    name:
                      description: T√™n thu·ªëc (c√≥ th·ªÉ l√† generic ho·∫∑c brand, nh∆∞ng
                        ƒë√£ ·∫©n danh n·∫øu tr√πng t√™n ri√™ng).
                      type: string
                  required:
                  - name
                  - dose
                  - frequency
                  type: object
                type: array
              past_medical_history:
                description: Ti·ªÅn s·ª≠ b·ªánh, d·∫°ng list c√°c d√≤ng text ƒë√£ ·∫©n danh.
                items:
                  type: string
                type: array
              physical_exam:
                description: Kh√°m l√¢m s√†ng t√≥m t·∫Øt, ƒë√£ ·∫©n danh.
                type: string
              plan:
                additionalProperties: false
                description: K·∫ø ho·∫°ch qu·∫£n l√Ω.
                properties:
                  education_and_counseling:
                    description: T∆∞ v·∫•n/gi√°o d·ª•c s·ª©c kh·ªèe.
                    items:
                      type: string
                    type: array
                  follow_up:
                    description: K·∫ø ho·∫°ch t√°i kh√°m/theo d√µi.
                    type: string
                  investigations:
                    description: C√°c CLS ƒë√£/ƒë·ªãnh ch·ªâ ƒë·ªãnh.
                    items:
                      type: string
                    type: array
                  treatments:
                    description: K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã/thu·ªëc.
                    items:
                      type: string
                    type: array
                required:
                - investigations
                - treatments
                - education_and_counseling
                - follow_up
                type: object
              review_of_systems:
                description: ROS d·∫°ng list text (m·ªói d√≤ng c√≥ th·ªÉ l√† 1 h·ªá c∆° quan).
                items:
                  type: string
                type: array
              social_history:
                description: Th√≥i quen sinh ho·∫°t, h√∫t thu·ªëc, r∆∞·ª£u bia..., ƒë√£ ·∫©n danh.
                type: string
              visit_type:
                description: Lo·∫°i l·∫ßn kh√°m (kh√°m ngo·∫°i tr√∫, t√°i kh√°m, c·∫•p c·ª©u...).
                type: string
              vital_signs:
                additionalProperties: false
                description: D·∫•u hi·ªáu sinh t·ªìn (VS).
                properties:
                  bp:
                    description: 'Huy·∫øt √°p (BP), v√≠ d·ª•: 150/90 mmHg.'
                    type: string
                  hr:
                    description: M·∫°ch / nh·ªãp tim (HR).
                    type: string
                  rr:
                    description: Nh·ªãp th·ªü (RR).
                    type: string
                  spo2:
                    description: SpO2.
                    type: string
                  temperature:
                    description: Nhi·ªát ƒë·ªô.
                    type: string
                type: object
            required:
            - chief_complaint
            - visit_type
            - history_of_present_illness
            - past_medical_history
            - medications
            - allergies
            - family_history
            - social_history
            - review_of_systems
            - vital_signs
            - physical_exam
            - labs_and_imaging
            - assessment
            - plan
            type: object
        structured_output_enabled: true
        title: PII_Redactor
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763802945681'
      position:
        x: 2868
        y: 258
      positionAbsolute:
        x: 2868
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763802945681'
          - text
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: fb2385cb-c70d-467a-8e2a-c97e28ce2f06
          role: system
          text: "B·∫°n l√† b√°c sƒ© n·ªôi khoa h·ªó tr·ª£ ghi ch√©p (medical scribe) cho CLARA.\n\
            \nNhi·ªám v·ª•:\n- Nh·∫≠n transcript h·ªôi tho·∫°i b√°c sƒ© ‚Äì b·ªánh nh√¢n (ƒë√£ ·∫©n danh)\
            \ ho·∫∑c note s∆° b·ªô.\n- Tr√≠ch xu·∫•t & c·∫•u tr√∫c l·∫°i th√¥ng tin l√¢m s√†ng th√†nh\
            \ c√°c m·ª•c:\n  - chief_complaint\n  - visit_type\n  - history_of_present_illness\n\
            \  - past_medical_history\n  - medications\n  - allergies\n  - family_history\n\
            \  - social_history\n  - review_of_systems\n  - vital_signs\n  - physical_exam\n\
            \  - labs_and_imaging\n  - assessment\n  - plan\n\nQuy t·∫Øc:\n- KH√îNG b·ªãa\
            \ th√™m d·ªØ li·ªáu. Thi·∫øu th√¨ ƒë·ªÉ tr·ªëng chu·ªói \"\" ho·∫∑c ghi r√µ \"kh√¥ng ƒë·ªÅ c·∫≠p\"\
            .\n- Kh√¥ng th√™m khuy·∫øn c√°o ƒëi·ªÅu tr·ªã m·ªõi; ch·ªâ ghi l·∫°i nh·ªØng g√¨ ƒë√£ ƒë∆∞·ª£c\
            \ nh·∫Øc.\n- D√πng ti·∫øng Vi·ªát (v√¨ transcript l√† ti·∫øng Vi·ªát).\n- Output PH·∫¢I\
            \ l√† JSON ƒë√∫ng schema ƒë√£ c·∫•u h√¨nh trong Structured Output c·ªßa node (kh√¥ng\
            \ b·ªçc th√™m text, kh√¥ng gi·∫£i th√≠ch)."
        - id: 207f264a-428d-48e9-9096-154323217360
          role: user
          text: Transcript h·ªôi tho·∫°i b√°c sƒ©‚Äìb·ªánh nh√¢n (ƒë√£ ·∫©n danh) {{#context#}}
        selected: false
        structured_output:
          schema:
            properties:
              allergies:
                description: D·ªã ·ª©ng thu·ªëc/th·ª©c ƒÉn n·∫øu c√≥.
                items:
                  type: string
                type: array
              assessment:
                description: Nh·∫≠n ƒë·ªãnh / ch·∫©n ƒëo√°n l√†m vi·ªác.
                items:
                  properties:
                    impression:
                      description: Nh·∫≠n ƒë·ªãnh chi ti·∫øt cho v·∫•n ƒë·ªÅ ƒë√≥.
                      type: string
                    problem:
                      description: V·∫•n ƒë·ªÅ/ch·∫©n ƒëo√°n.
                      type: string
                  required:
                  - problem
                  - impression
                  type: object
                type: array
              chief_complaint:
                description: L√Ω do v√†o kh√°m ch√≠nh c·ªßa b·ªánh nh√¢n.
                type: string
              family_history:
                description: Ti·ªÅn s·ª≠ gia ƒë√¨nh.
                type: string
              history_of_present_illness:
                description: Di·ªÖn ti·∫øn b·ªánh hi·ªán t·∫°i (HPI).
                type: string
              labs_and_imaging:
                description: C·∫≠n l√¢m s√†ng, x√©t nghi·ªám, ch·∫©n ƒëo√°n h√¨nh ·∫£nh.
                type: string
              medications:
                description: C√°c thu·ªëc ƒëang d√πng.
                items:
                  properties:
                    dose:
                      description: 'Li·ªÅu d√πng (v√≠ d·ª•: 500mg).'
                      type: string
                    frequency:
                      description: 'C√°ch d√πng / t·∫ßn su·∫•t (v√≠ d·ª•: s√°ng, t·ªëi).'
                      type: string
                    name:
                      description: T√™n thu·ªëc ho·∫∑c ho·∫°t ch·∫•t.
                      type: string
                  required:
                  - name
                  - dose
                  - frequency
                  type: object
                type: array
              past_medical_history:
                description: B·ªánh s·ª≠ c≈©, danh s√°ch c√°c b·ªánh/ch·∫©n ƒëo√°n tr∆∞·ªõc ƒë√¢y.
                items:
                  type: string
                type: array
              physical_exam:
                description: Kh√°m l√¢m s√†ng.
                type: string
              plan:
                description: K·∫ø ho·∫°ch x·ª≠ tr√≠.
                properties:
                  education_and_counseling:
                    description: Gi√°o d·ª•c, t∆∞ v·∫•n cho b·ªánh nh√¢n.
                    items:
                      type: string
                    type: array
                  follow_up:
                    description: K·∫ø ho·∫°ch t√°i kh√°m/theo d√µi.
                    type: string
                  investigations:
                    description: Danh s√°ch c·∫≠n l√¢m s√†ng/x√©t nghi·ªám d·ª± ki·∫øn.
                    items:
                      type: string
                    type: array
                  treatments:
                    description: ƒêi·ªÅu tr·ªã ƒë√£/b·ªã ƒë·ªÅ c·∫≠p.
                    items:
                      type: string
                    type: array
                required:
                - investigations
                - treatments
                - education_and_counseling
                - follow_up
                type: object
              review_of_systems:
                description: C√°c tri·ªáu ch·ª©ng to√†n th√¢n theo h·ªá th·ªëng.
                items:
                  type: string
                type: array
              social_history:
                description: 'Th√≥i quen sinh ho·∫°t: h√∫t thu·ªëc, r∆∞·ª£u bia, ngh·ªÅ nghi·ªáp...'
                type: string
              visit_type:
                description: 'Lo·∫°i l·∫ßn kh√°m, v√≠ d·ª•: Kh√°m ngo·∫°i tr√∫, c·∫•p c·ª©u...'
                type: string
              vital_signs:
                description: D·∫•u hi·ªáu sinh t·ªìn.
                properties:
                  bp:
                    description: Huy·∫øt √°p.
                    type: string
                  hr:
                    description: Nh·ªãp tim.
                    type: string
                  rr:
                    description: Nh·ªãp th·ªü.
                    type: string
                  spo2:
                    description: SpO2.
                    type: string
                  temperature:
                    description: Nhi·ªát ƒë·ªô.
                    type: string
                required:
                - bp
                - hr
                - rr
                - temperature
                - spo2
                type: object
            required:
            - chief_complaint
            - visit_type
            - history_of_present_illness
            - past_medical_history
            - medications
            - allergies
            - family_history
            - social_history
            - review_of_systems
            - vital_signs
            - physical_exam
            - labs_and_imaging
            - assessment
            - plan
            type: object
        structured_output_enabled: true
        title: Clinical_Structurer
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763803754384'
      position:
        x: 3200
        y: 258
      positionAbsolute:
        x: 3200
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763803754384'
          - text
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 4e70774e-a7f6-40db-9a5f-d197ef89096d
          role: system
          text: "B·∫°n l√† module so√°t l·ªói cho note l√¢m s√†ng gi√°o d·ª•c.\nNhi·ªám v·ª•:\n-\
            \ Ki·ªÉm tra t√≠nh nh·∫•t qu√°n n·ªôi b·ªô gi·ªØa c√°c m·ª•c (chief complaint ‚Äì HPI ‚Äì\
            \ assessment ‚Äì plan).\n- Kh√¥ng th√™m d·ªØ li·ªáu m·ªõi; ch·ªâ ƒë∆∞·ª£c:\n  + G·ª£i √Ω\
            \ d·∫°ng ‚ÄúC√≥ v·∫ª thi·∫øu th√¥ng tin v·ªÅ X (kh√¥ng th·∫•y nh·∫Øc trong transcript)‚Äù.\n\
            - T·∫°o 2 ph·∫ßn:\n  + clean_note: b·∫£n note s·∫°ch s·∫Ω, m·∫°ch l·∫°c, ho√†n ch·ªânh\
            \ c√¢u ch·ªØ nh∆∞ng kh√¥ng thay ƒë·ªïi th√¥ng tin so v·ªõi note_struct (tr·∫£ v·ªÅ 1\
            \ chu·ªói vƒÉn b·∫£n).\n  + missing_info_notes: danh s√°ch g·∫°ch ƒë·∫ßu d√≤ng c√°c\
            \ th√¥ng tin n√™n h·ªèi th√™m / c√≤n thi·∫øu (m·ªói ph·∫ßn t·ª≠ l√† 1 chu·ªói).\n  + safety_disclaimer:\
            \ ƒëo·∫°n c·∫£nh b√°o c·ªë ƒë·ªãnh r·∫±ng ƒë√¢y ch·ªâ l√† c√¥ng c·ª• h·ªó tr·ª£ ghi ch√©p, kh√¥ng\
            \ thay th·∫ø b√°c sƒ©.\n\nTr·∫£ v·ªÅ DUY NH·∫§T JSON ƒë√∫ng schema ƒë√£ c·∫•u h√¨nh (clean_note,\
            \ missing_info_notes, safety_disclaimer), kh√¥ng th√™m text ngo√†i JSON."
        - id: d5d2a2c4-d006-493b-8318-284d1d6b9f96
          role: user
          text: 'Clinical Structure: {{#context#}}

            Redacted note (g·ªëc): {{#1763802945681.text#}}

            '
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              clean_note:
                description: B·∫£n note s·∫°ch s·∫Ω, m·∫°ch l·∫°c, kh√¥ng th√™m ho·∫∑c thay ƒë·ªïi
                  th√¥ng tin so v·ªõi note_struct (m·ªôt ƒëo·∫°n text duy nh·∫•t).
                type: string
              missing_info_notes:
                description: Danh s√°ch g·∫°ch ƒë·∫ßu d√≤ng c√°c th√¥ng tin c√≤n thi·∫øu ho·∫∑c
                  n√™n h·ªèi th√™m.
                items:
                  type: string
                type: array
              safety_disclaimer:
                description: ƒêo·∫°n c·∫£nh b√°o c·ªë ƒë·ªãnh r·∫±ng ƒë√¢y ch·ªâ l√† c√¥ng c·ª• h·ªó tr·ª£
                  ghi ch√©p, kh√¥ng thay th·∫ø b√°c sƒ©.
                type: string
            required:
            - clean_note
            - missing_info_notes
            - safety_disclaimer
            type: object
        structured_output_enabled: true
        title: Note_Reviewer
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763803836243'
      position:
        x: 5524
        y: 518
      positionAbsolute:
        x: 5524
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        selected: false
        template: "{# n = clinical struct, r = review #}\r\n\r\n## CLARA Medical Scribe\
          \ ‚Äì Note bu·ªïi kh√°m\r\n\r\n### 1. Chief complaint (CC)\r\n{{ n.chief_complaint\
          \ | default(\"Kh√¥ng ghi\") }}\r\n\r\n---\r\n\r\n### 2. History of Present\
          \ Illness (HPI)\r\n{{ n.history_of_present_illness | default(\"Kh√¥ng ghi\"\
          ) }}\r\n\r\n---\r\n\r\n### 3. Past medical history\r\n{{ n.past_medical_history\
          \ | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 4. Medications (thu·ªëc\
          \ ƒëang d√πng)\r\n{{ n.medications | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n\
          ---\r\n\r\n### 5. Allergies (d·ªã ·ª©ng)\r\n{{ n.allergies | default(\"Kh√¥ng\
          \ ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 6. Family history\r\n{{ n.family_history\
          \ | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 7. Social history\r\
          \n{{ n.social_history | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n\
          ### 8. Review of systems\r\n{{ n.review_of_systems | default(\"Kh√¥ng ƒë·ªÅ\
          \ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 9. Vital signs\r\n{% if n.vital_signs\
          \ is defined %}\r\n{{ n.vital_signs }}\r\n{% else %}\r\n- Huy·∫øt √°p (BP):\
          \ Kh√¥ng ghi  \r\n- M·∫°ch (HR): Kh√¥ng ghi  \r\n- Nh·ªãp th·ªü (RR): Kh√¥ng ghi\
          \  \r\n- SpO‚ÇÇ: Kh√¥ng ghi  \r\n- Nhi·ªát ƒë·ªô: Kh√¥ng ghi\r\n{% endif %}\r\n\r\
          \n---\r\n\r\n### 10. Physical exam (kh√°m l√¢m s√†ng)\r\n{{ n.physical_exam\
          \ | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 11. Labs / Imaging\
          \ (c·∫≠n l√¢m s√†ng)\r\n{{ n.labs_and_imaging | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\
          \n\r\n---\r\n\r\n### 12. Assessment (ƒë√°nh gi√° / ch·∫©n ƒëo√°n l√†m vi·ªác)\r\n\
          {{ n.assessment | default(\"Kh√¥ng ƒë·ªÅ c·∫≠p\") }}\r\n\r\n---\r\n\r\n### 13.\
          \ Plan\r\n\r\n{% set plan = n.plan | default({}) %}\r\n\r\n**13.1. Investigations\
          \ (c·∫≠n l√¢m s√†ng d·ª± ki·∫øn):**\r\n{% if plan.investigations is defined %}\r\
          \n{{ plan.investigations }}\r\n{% else %}\r\nKh√¥ng ƒë·ªÅ c·∫≠p\r\n{% endif %}\r\
          \n\r\n**13.2. Treatments (ƒëi·ªÅu tr·ªã / thu·ªëc):**\r\n{% if plan.treatments\
          \ is defined %}\r\n{{ plan.treatments }}\r\n{% else %}\r\nKh√¥ng ƒë·ªÅ c·∫≠p\r\
          \n{% endif %}\r\n\r\n**13.3. Education & counseling (gi√°o d·ª•c / t∆∞ v·∫•n):**\r\
          \n{% if plan.education_and_counseling is defined %}\r\n{{ plan.education_and_counseling\
          \ }}\r\n{% else %}\r\nKh√¥ng ƒë·ªÅ c·∫≠p\r\n{% endif %}\r\n\r\n**13.4. Follow-up\
          \ (t√°i kh√°m / theo d√µi):**\r\n{% if plan.follow_up is defined %}\r\n{{ plan.follow_up\
          \ }}\r\n{% else %}\r\nKh√¥ng ƒë·ªÅ c·∫≠p\r\n{% endif %}\r\n\r\n---\r\n\r\n###\
          \ 14. B·∫£n note ƒë√£ bi√™n t·∫≠p (clean note)\r\n\r\n{{ r.clean_note | default(\"\
          \") }}\r\n\r\n---\r\n\r\n### 15. Th√¥ng tin c√≤n thi·∫øu / c·∫ßn h·ªèi th√™m\r\n\r\
          \n{% if r.missing_info_notes is defined and r.missing_info_notes and r.missing_info_notes|length\
          \ > 0 %}\r\n{% for item in r.missing_info_notes %}\r\n- {{ item }}\r\n{%\
          \ endfor %}\r\n{% else %}\r\n- Kh√¥ng c√≥ nh·∫≠n x√©t th√™m.\r\n{% endif %}\r\n\
          \r\n---\r\n\r\n{{ r.safety_disclaimer | default(\"\") }}\r\n\r\n{% if evidence_block\
          \ %}\r\n---\r\n{{ evidence_block }}\r\n{% endif %}\r\n"
        title: TEMPLATE node ƒë·ªÉ ƒë·ªãnh d·∫°ng note
        type: template-transform
        variables:
        - value_selector:
          - '1763803754384'
          - structured_output
          value_type: object
          variable: n
        - value_selector:
          - '1763803836243'
          - structured_output
          value_type: object
          variable: r
        - value_selector:
          - '1763812737094'
          - output
          value_type: string
          variable: evidence_block
      height: 51
      id: '1763804168711'
      position:
        x: 5856
        y: 518
      positionAbsolute:
        x: 5856
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#1763804168711.output#}}'
        selected: false
        title: Answer_Final
        type: answer
        variables: []
      height: 101
      id: '1763804449838'
      position:
        x: 6188
        y: 518
      positionAbsolute:
        x: 6188
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763803754384'
          - structured_output
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 92f7339c-23a2-42db-b6ce-cf3078623f1b
          role: system
          text: "B·∫°n l√† module TERMINOLOGY_EXTRACTOR cho CLARA.\n\nNhi·ªám v·ª•:\n- Nh·∫≠n\
            \ note l√¢m s√†ng ƒë√£ c·∫•u tr√∫c (output t·ª´ CLINICAL_STRUCTURER: assessment,\
            \ plan, medications).\n- Tr√≠ch ra danh s√°ch entity y khoa quan tr·ªçng c·∫ßn\
            \ m√£ h√≥a / lookup:\n  - Lo·∫°i \"disease\": b·ªánh, h·ªôi ch·ª©ng, ch·∫©n ƒëo√°n.\n\
            \  - Lo·∫°i \"drug\": thu·ªëc, ho·∫°t ch·∫•t, ch·∫ø ph·∫©m.\n- Chu·∫©n h√≥a ti·∫øng Anh\
            \ y khoa (normalized_en) cho t·ª´ng entity.\n- ƒê·∫∑t c√°c c·ªù:\n  - need_icd11:\
            \ cho entity type = \"disease\" n·∫øu c·∫ßn m√£ ICD-11.\n  - need_rxnorm: cho\
            \ entity type = \"drug\" n·∫øu c·∫ßn m√£ RxNorm.\n  - need_openfda: cho entity\
            \ type = \"drug\" n·∫øu c·∫ßn tra openFDA (safety/recall).\n  - need_umls:\
            \ true cho m·ªçi entity quan tr·ªçng.\n  - need_trials: true cho disease ch√≠nh\
            \ (is_primary = true) c·∫ßn t√¨m clinical trials.\n\nQuy t·∫Øc:\n- Kh√¥ng b·ªãa\
            \ th√™m b·ªánh / thu·ªëc kh√¥ng xu·∫•t hi·ªán trong note.\n- N·∫øu ch∆∞a ch·∫Øc v·ªÅ normalized_en,\
            \ d√πng b·∫£n d·ªãch g·∫ßn nh·∫•t, c√≥ th·ªÉ ch·ªânh sau.\n- N·∫øu m·ªôt entity ch·ªâ ƒë·ªÉ tham\
            \ kh·∫£o, c√≥ th·ªÉ set c√°c c·ªù need_* = false.\n- N·∫øu kh√¥ng c√≥ entity n√†o ph√π\
            \ h·ª£p, tr·∫£ v·ªÅ \"entities\": [].\n\nR·∫§T QUAN TR·ªåNG:\n- Tr·∫£ v·ªÅ DUY NH·∫§T\
            \ m·ªôt JSON **data** ƒë√∫ng schema Structured Output ƒë√£ c·∫•u h√¨nh (kh√¥ng in\
            \ l·∫°i JSON Schema, kh√¥ng gi·∫£i th√≠ch th√™m)."
        - id: a6d2f9f2-ed11-4d42-a4ce-002e40d0e29e
          role: user
          text: 'CLINICAL_STRUCTURER: {{#context#}}'
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              entities:
                description: List of extracted medical entities (diseases and drugs)
                  that need coding / lookup.
                items:
                  additionalProperties: false
                  properties:
                    id:
                      description: A unique identifier for the entity (e.g. e1, e2,
                        ...).
                      type: string
                    is_primary:
                      description: True n·∫øu ƒë√¢y l√† ch·∫©n ƒëo√°n ch√≠nh / l√Ω do ch√≠nh ƒë·∫øn
                        kh√°m.
                      type: boolean
                    need_icd11:
                      description: True n·∫øu entity n√†y c·∫ßn query ICD-11 (√°p d·ª•ng cho
                        disease).
                      type: boolean
                    need_openfda:
                      description: True n·∫øu entity n√†y c·∫ßn tra c·ª©u openFDA (th∆∞·ªùng
                        cho thu·ªëc / safety).
                      type: boolean
                    need_rxnorm:
                      description: True n·∫øu entity n√†y c·∫ßn query RxNorm (√°p d·ª•ng cho
                        drug).
                      type: boolean
                    need_trials:
                      description: True n·∫øu entity (th∆∞·ªùng l√† disease ch√≠nh) c·∫ßn tra
                        clinical trials.
                      type: boolean
                    need_umls:
                      description: True n·∫øu entity n√†y c·∫ßn mapping sang UMLS CUI.
                      type: boolean
                    normalized_en:
                      description: The normalized medical term in English (best-guess).
                      type: string
                    original_text:
                      description: The term exactly as it appeared in the original
                        note.
                      type: string
                    type:
                      description: 'Entity type: disease or drug.'
                      enum:
                      - disease
                      - drug
                      type: string
                  required:
                  - id
                  - type
                  - original_text
                  - normalized_en
                  - is_primary
                  - need_icd11
                  - need_rxnorm
                  - need_umls
                  - need_openfda
                  - need_trials
                  type: object
                type: array
            required:
            - entities
            type: object
        structured_output_enabled: true
        title: TERMINOLOGY_EXTRACTOR
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763808107990'
      position:
        x: 3532
        y: 258
      positionAbsolute:
        x: 3532
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763808107990'
          - structured_output
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 8fde2ed3-752a-4f37-a521-b26d3331fa4d
          role: system
          text: "B·∫°n l√† module BUILD_QUERIES cho h·ªá th·ªëng CLARA.\n\nNhi·ªám v·ª•:\n- Ch·ªçn\
            \ ra:\n  - 1 b·ªánh (disease) ch√≠nh ƒë·ªÉ l√†m query cho ICD-11, UMLS v√† ClinicalTrials\
            \ (th∆∞·ªùng l√† ch·∫©n ƒëo√°n quan tr·ªçng nh·∫•t).\n  - 1 thu·ªëc (drug) ch√≠nh ƒë·ªÉ\
            \ l√†m query cho RxNorm, UMLS v√† openFDA (th∆∞·ªùng l√† thu·ªëc ƒëi·ªÅu tr·ªã ch√≠nh\
            \ ho·∫∑c c·∫ßn quan t√¢m v·ªÅ an to√†n).\n- Sinh ra c√°c keyword phrase ch√≠nh,\
            \ nh·ªè, c√≥ th·ªÉ search ƒë∆∞·ª£c ƒë·ªÉ query text, t∆∞∆°ng th√≠ch v·ªõi t·ª´ng API:\n \
            \ 1. icd11_query: d√πng ti·∫øng Anh y khoa, t·∫≠p trung v√†o disease ch√≠nh.\n\
            \  2. rxnorm_query: t√™n thu·ªëc ch√≠nh b·∫±ng ti·∫øng Anh, kh√¥ng k√®m li·ªÅu.\n\
            \  3. umls_query: c√≥ th·ªÉ d√πng disease ch√≠nh ho·∫∑c thu·ªëc ch√≠nh, ∆∞u ti√™n\
            \ disease n·∫øu c√≥.\n  4. openfda_query: t√™n lo·∫°i thu·ªëc kh√¥ng k√®m li·ªÅu.\n\
            \  5. trials_query: th∆∞·ªùng l√† b·ªánh ch√≠nh.\n     \nQuy t·∫Øc:\n- Kh√¥ng b·ªãa\
            \ th√™m b·ªánh/thu·ªëc kh√¥ng xu·∫•t hi·ªán trong entities.\n- ∆Øu ti√™n d√πng tr∆∞·ªùng\
            \ normalized_en n·∫øu c√≥; n·∫øu kh√¥ng c√≥, t·ª± d·ªãch ng·∫Øn g·ªçn sang ti·∫øng Anh\
            \ y khoa.\n- N·∫øu kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ t·∫°o query cho 1 lo·∫°i API, ƒë·ªÉ tr∆∞·ªùng\
            \ t∆∞∆°ng ·ª©ng = null.\n\nCh·ªâ tr·∫£ v·ªÅ DUY NH·∫§T JSON ƒë√∫ng schema ƒë√£ cho, kh√¥ng\
            \ gi·∫£i th√≠ch th√™m.\n"
        - id: 3fd275a0-7b33-4409-bbaa-d0f469ddf5c8
          role: user
          text: '- Nh·∫≠n {{#context#}}, clinical structurer: {{#1763803754384.structured_output#}}'
        selected: false
        structured_output:
          schema:
            properties:
              icd11_query:
                description: 'T√™n b·ªánh ch√≠nh (English) ƒë·ªÉ query ICD-11 Clinical Tables,
                  v√≠ d·ª•: "stable angina pectoris".'
                type: string
              openfda_query:
                description: 'T√™n thu·ªëc ch√≠nh ƒë·ªÉ query openFDA drug event, v√≠ d·ª•:
                  "metformin" ho·∫∑c "dapagliflozin".'
                type: string
              rxnorm_query:
                description: 'T√™n thu·ªëc ch√≠nh (English) ƒë·ªÉ query RxNorm, v√≠ d·ª•: "metformin".'
                type: string
              trials_query:
                description: 'C·ª•m t·ª´ b·ªánh + (tu·ª≥ ch·ªçn) thu·ªëc ƒë·ªÉ query ClinicalTrials,
                  v√≠ d·ª•: "type 2 diabetes mellitus dapagliflozin" ho·∫∑c "stable angina
                  pectoris".'
                type: string
              umls_query:
                description: 'Term t·ªïng qu√°t (English) ƒë·ªÉ query UMLS, th∆∞·ªùng l√† b·ªánh
                  ch√≠nh ho·∫∑c kh√°i ni·ªám trung t√¢m, v√≠ d·ª•: "type 2 diabetes mellitus".'
                type: string
            required:
            - rxnorm_query
            - icd11_query
            - umls_query
            - openfda_query
            - trials_query
            type: object
        structured_output_enabled: true
        title: Build_Queries
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763811812908'
      position:
        x: 3864
        y: 258
      positionAbsolute:
        x: 3864
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1763808107990'
          - structured_output
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro
          provider: langgenius/gemini/google
        prompt_template:
        - id: 980b80b0-fec6-4625-822a-e97fcba63843
          role: system
          text: "B·∫°n l√† CODING_EVIDENCE_COMBINER cho CLARA.\n\nInput:\n- Danh s√°ch\
            \ entities t·ª´ TERMINOLOGY_EXTRACTOR (id, type, normalized_en‚Ä¶).\n- K·∫øt\
            \ qu·∫£ raw t·ª´ c√°c API: ICD-11, RxNorm, UMLS, openFDA, ClinicalTrials t∆∞∆°ng\
            \ ·ª©ng t·ª´ng entity.\n\nNhi·ªám v·ª• v·ªõi m·ªói entity:\n- T·ªïng h·ª£p c√°c candidate\
            \ t·ª´ t·ª´ng h·ªá th·ªëng (ICD-11, RxNorm, UMLS, openFDA, ClinicalTrials).\n\
            - ƒê·ªï v√†o c√°c m·∫£ng icd11_candidates, rxnorm_candidates, umls_candidates,\
            \ trials_summary ƒë√∫ng schema.\n- openfda_summary: 1‚Äì2 c√¢u t√≥m t·∫Øt c·∫£nh\
            \ b√°o / ADR quan tr·ªçng, n·∫øu kh√¥ng c√≥ th√¨ d√πng chu·ªói r·ªóng.\n- best_guess:\n\
            \  - Ch·ªâ ƒëi·ªÅn code khi th·∫•y t∆∞∆°ng ƒë·ªëi ch·∫Øc ch·∫Øn d·ª±a tr√™n candidates.\n\
            \  - N·∫øu kh√¥ng ƒë·ªß ch·∫Øc ch·∫Øn ho·∫∑c kh√¥ng c√≥ k·∫øt qu·∫£: ƒë·ªÉ null (ho·∫∑c chu·ªói\
            \ r·ªóng n·∫øu schema kh√¥ng cho null).\n- comment: gi·∫£i th√≠ch ng·∫Øn v·ªÅ m·ª©c\
            \ ƒë·ªô tin c·∫≠y / gi·ªõi h·∫°n mapping.\n\nQuy t·∫Øc:\n- Kh√¥ng b·ªãa m√£ m·ªõi khi API\
            \ kh√¥ng tr·∫£ k·∫øt qu·∫£.\n- Kh√¥ng suy lu·∫≠n qu√° m·ª©c t·ª´ th√¥ng tin kh√¥ng c√≥.\n\
            - T·∫•t c·∫£ ch·ªâ d√πng cho gi√°o d·ª•c / tham kh·∫£o, kh√¥ng d√πng cho m√£ h√≥a thanh\
            \ to√°n ho·∫∑c k√™ ƒë∆°n tr·ª±c ti·∫øp.\nTr∆∞·ªùng best_guess.icd11, best_guess.rxnorm,\
            \ best_guess.umls_cui n·∫øu kh√¥ng c√≥ m√£ ph√π h·ª£p, h√£y:\nho·∫∑c b·ªè h·∫≥n field\
            \ ƒë√≥,\nho·∫∑c tr·∫£ \"\" (chu·ªói r·ªóng).\nKh√¥ng d√πng gi√° tr·ªã null cho c√°c tr∆∞·ªùng\
            \ n√†y.\nTr·∫£ v·ªÅ DUY NH·∫§T JSON ƒë√∫ng schema ƒë√£ c·∫•u h√¨nh trong Structured\
            \ Output, kh√¥ng th√™m gi·∫£i th√≠ch ngo√†i JSON."
        - id: 51dbc468-dab3-48c3-bc9a-2e4068f22b51
          role: user
          text: 'Entities:

            {{#context#}}

            K·∫øt qu·∫£ ICD-11 raw, RxNorm raw, UMLS raw, openFDA raw, ClinicalTrials
            raw:

            {{#1763828512463.output#}}'
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              entity_summaries:
                items:
                  additionalProperties: false
                  properties:
                    best_guess:
                      additionalProperties: false
                      properties:
                        icd11:
                          description: Best ICD-11 code for this entity if available,
                            otherwise empty string or omit.
                          type: string
                        rxnorm:
                          description: Best RxNorm RXCUI for this entity if available,
                            otherwise empty string or omit.
                          type: string
                        umls_cui:
                          description: Best UMLS CUI for this entity if available,
                            otherwise empty string or omit.
                          type: string
                      type: object
                    comment:
                      description: Brief explanation of confidence, limitations, or
                        why a best_guess was or was not chosen.
                      type: string
                    entity_id:
                      type: string
                    icd11_candidates:
                      items:
                        properties:
                          code:
                            type: string
                          score:
                            type: number
                          title:
                            type: string
                        required:
                        - code
                        - title
                        - score
                        type: object
                      type: array
                    openfda_summary:
                      description: 1-2 sentence summary of most important warnings
                        / adverse events. Empty string if not applicable or no data.
                      type: string
                    original_text:
                      type: string
                    rxnorm_candidates:
                      items:
                        properties:
                          name:
                            type: string
                          rxcui:
                            type: string
                          score:
                            type: number
                          tty:
                            type: string
                        required:
                        - rxcui
                        - name
                        - tty
                        - score
                        type: object
                      type: array
                    trials_summary:
                      items:
                        properties:
                          location_countries:
                            items:
                              type: string
                            type: array
                          nct_id:
                            type: string
                          overall_status:
                            type: string
                          phase:
                            type: string
                          title:
                            type: string
                        required:
                        - nct_id
                        - title
                        - phase
                        - overall_status
                        - location_countries
                        type: object
                      type: array
                    type:
                      enum:
                      - disease
                      - drug
                      type: string
                    umls_candidates:
                      items:
                        properties:
                          cui:
                            type: string
                          preferred_term:
                            type: string
                          score:
                            type: number
                        required:
                        - cui
                        - preferred_term
                        - score
                        type: object
                      type: array
                  required:
                  - entity_id
                  - original_text
                  - type
                  - icd11_candidates
                  - rxnorm_candidates
                  - umls_candidates
                  - openfda_summary
                  - trials_summary
                  - best_guess
                  - comment
                  type: object
                type: array
              global_warnings:
                items:
                  type: string
                type: array
            required:
            - entity_summaries
            - global_warnings
            type: object
        structured_output_enabled: true
        title: CODING_EVIDENCE_COMBINER
        type: llm
        vision:
          enabled: false
      height: 87
      id: '1763812453361'
      position:
        x: 4860
        y: 518
      positionAbsolute:
        x: 4860
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        selected: false
        template: "{# evidence_block = {\r\n     \"entity_summaries\": [... ho·∫∑c {\"\
          items\":[...]}],\r\n     \"global_warnings\": [... ho·∫∑c {\"items\":[...]}]\r\
          \n   }\r\n#}\r\n\r\n{% set eb = evidence_block | default({}) %}\r\n\r\n\
          {# L·∫•y danh s√°ch entity_summaries #}\r\n{% set es = [] %}\r\n{% if eb.entity_summaries\
          \ is defined %}\r\n  {% set es = eb.entity_summaries %}\r\n{% endif %}\r\
          \n{% if es and es.keys is defined and ('items' in es) %}\r\n  {% set es\
          \ = es['items'] %}\r\n{% endif %}\r\n{% if es is string %}\r\n  {% set es\
          \ = [] %}\r\n{% endif %}\r\n\r\n{# L·∫•y danh s√°ch global_warnings #}\r\n\
          {% set gw = [] %}\r\n{% if eb.global_warnings is defined %}\r\n  {% set\
          \ gw = eb.global_warnings %}\r\n{% endif %}\r\n{% if gw and gw.keys is defined\
          \ and ('items' in gw) %}\r\n  {% set gw = gw['items'] %}\r\n{% endif %}\r\
          \n{% if gw is string %}\r\n  {% set gw = [gw] %}\r\n{% endif %}\r\n\r\n\
          ---\r\n\r\n## G·ª£i √Ω m√£ h√≥a & b·∫±ng ch·ª©ng (tham kh·∫£o)\r\n\r\n{% if es and\
          \ es|length > 0 %}\r\n{% for e in es %}\r\n\r\n### {{ loop.index }}. {{\
          \ e.original_text | default(e.entity_id | default('Entity kh√¥ng t√™n')) }}\r\
          \n\r\n**ID n·ªôi b·ªô:** {{ e.entity_id | default('N/A') }}\r\n\r\n{# ICD-11\
          \ #}\r\n{% if e.icd11_candidates is defined and e.icd11_candidates %}\r\n\
          \  {% set icd = e.icd11_candidates %}\r\n  {% if icd.keys is defined and\
          \ ('items' in icd) %}\r\n    {% set icd = icd['items'] %}\r\n  {% endif\
          \ %}\r\n  {% if icd and icd|length > 0 %}\r\n**ICD-11 (·ª©ng vi√™n):**\r\n\
          \  {% for c in icd %}\r\n- {{ c.code | default('') }}{% if c.title %} ‚Äì\
          \ {{ c.title }}{% endif %}{% if c.score is defined %} (score ~ {{ (c.score*100)|round(1)\
          \ }}%){% endif %}\r\n  {% endfor %}\r\n  {% endif %}\r\n{% endif %}\r\n\r\
          \n{# RxNorm #}\r\n{% if e.rxnorm_candidates is defined and e.rxnorm_candidates\
          \ %}\r\n  {% set rx = e.rxnorm_candidates %}\r\n  {% if rx.keys is defined\
          \ and ('items' in rx) %}\r\n    {% set rx = rx['items'] %}\r\n  {% endif\
          \ %}\r\n  {% if rx and rx|length > 0 %}\r\n**RxNorm (·ª©ng vi√™n):**\r\n  {%\
          \ for r in rx %}\r\n- {% if r.rxcui %}RXCUI {{ r.rxcui }}{% else %}(ch∆∞a\
          \ c√≥ RXCUI){% endif %}{% if r.name %} ‚Äì {{ r.name }}{% endif %}{% if r.tty\
          \ %} ({{ r.tty }}){% endif %}{% if r.score is defined %} (score ~ {{ (r.score*100)|round(1)\
          \ }}%){% endif %}\r\n  {% endfor %}\r\n  {% endif %}\r\n{% endif %}\r\n\r\
          \n{# UMLS #}\r\n{% if e.umls_candidates is defined and e.umls_candidates\
          \ %}\r\n  {% set uu = e.umls_candidates %}\r\n  {% if uu.keys is defined\
          \ and ('items' in uu) %}\r\n    {% set uu = uu['items'] %}\r\n  {% endif\
          \ %}\r\n  {% if uu and uu|length > 0 %}\r\n**UMLS (·ª©ng vi√™n):**\r\n  {%\
          \ for u in uu %}\r\n- {{ u.cui | default('CUI?') }}{% if u.preferred_term\
          \ %} ‚Äì {{ u.preferred_term }}{% endif %}{% if u.score is defined %} (score\
          \ ~ {{ (u.score*100)|round(1) }}%){% endif %}\r\n  {% endfor %}\r\n  {%\
          \ endif %}\r\n{% endif %}\r\n\r\n{# Clinical trials #}\r\n{% set trials_raw\
          \ = e.trials_summary | default({}) %}\r\n{% set trials = [] %}\r\n{% if\
          \ trials_raw and trials_raw.keys is defined and ('items' in trials_raw)\
          \ %}\r\n  {% set trials = trials_raw['items'] %}\r\n{% elif trials_raw and\
          \ (trials_raw is sequence) and not (trials_raw is string) %}\r\n  {% set\
          \ trials = trials_raw %}\r\n{% endif %}\r\n{% if trials and trials|length\
          \ > 0 %}\r\n**Th·ª≠ nghi·ªám l√¢m s√†ng li√™n quan:**\r\n{% for t in trials %}\r\
          \n- {{ t.nct_id | default('NCT?') }} ‚Äì {{ t.title | default('Kh√¥ng c√≥ ti√™u\
          \ ƒë·ªÅ') }}\r\n  - Giai ƒëo·∫°n: {{ t.phase | default('N/A') }}\r\n  - T√¨nh tr·∫°ng:\
          \ {{ t.overall_status | default('N/A') }}\r\n  - Qu·ªëc gia: {{ t.location_countries\
          \ | default('N/A') }}\r\n{% endfor %}\r\n{% endif %}\r\n\r\n{# openFDA #}\r\
          \n{% if e.openfda_summary %}\r\n**T√≥m t·∫Øt an to√†n (openFDA):**\r\n  {% if\
          \ e.openfda_summary.description is defined %}\r\n{{ e.openfda_summary.description\
          \ }}\r\n  {% else %}\r\n{{ e.openfda_summary }}\r\n  {% endif %}\r\n{% endif\
          \ %}\r\n\r\n{# best_guess #}\r\n{% if e.best_guess is defined %}\r\n**Best\
          \ guess (n·∫øu c√≥):**\r\n- ICD-11: {{ e.best_guess.icd11 | default('N/A')\
          \ }}\r\n- RxNorm: {{ e.best_guess.rxnorm | default('N/A') }}\r\n- UMLS CUI:\
          \ {{ e.best_guess.umls_cui | default('N/A') }}\r\n{% endif %}\r\n\r\n{#\
          \ comment #}\r\n{% if e.comment %}\r\n> Ghi ch√∫: {% if e.comment.description\
          \ is defined %}{{ e.comment.description }}{% else %}{{ e.comment }}{% endif\
          \ %}\r\n{% endif %}\r\n\r\n---\r\n{% endfor %}\r\n{% else %}\r\nKh√¥ng c√≥\
          \ entity n√†o ƒë·ªÉ m√£ ho√° / tra c·ª©u.\r\n{% endif %}\r\n\r\n{% if gw and gw|length\
          \ > 0 %}\r\n> **C·∫£nh b√°o chung:**\r\n{% for w in gw %}\r\n> - {{ w }}\r\n\
          {% endfor %}\r\n{% endif %}\r\n\r\n> *T·∫•t c·∫£ g·ª£i √Ω tr√™n ch·ªâ ph·ª•c v·ª• nghi√™n\
          \ c·ª©u / gi√°o d·ª•c, kh√¥ng d√πng tr·ª±c ti·∫øp cho m√£ h√≥a thanh to√°n ho·∫∑c k√™ ƒë∆°n.\
          \ Lu√¥n c·∫ßn b√°c sƒ© v√† coder ki·ªÉm tra l·∫°i.*\r\n"
        title: TEMPLATE_EVIDENCE
        type: template-transform
        variables:
        - value_selector:
          - '1763812453361'
          - structured_output
          value_type: object
          variable: evidence_block
      height: 51
      id: '1763812737094'
      position:
        x: 5192
        y: 518
      positionAbsolute:
        x: 5192
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - 8RT0x7LEHmIanqFyXU3YwpG5c2uQbgagZY7ND9j6E4KncubIIkE7GmQ4LiSoNoPU
        multiple_retrieval_config:
          reranking_enable: false
          reranking_mode: reranking_model
          score_threshold: null
          top_k: 5
        query_variable_selector:
        - '1763811812908'
        - structured_output
        - icd11_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval
        type: knowledge-retrieval
      height: 89
      id: '1763823575062'
      position:
        x: 4196
        y: 258
      positionAbsolute:
        x: 4196
        y: 258
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - vMGBlLf1GZls5tFS0O9Telaid2okUS5RZ9TiH7foRMW7dZnf9zV7/vwygKLvRpCa
        multiple_retrieval_config:
          reranking_enable: false
          reranking_mode: reranking_model
          top_k: 4
        query_variable_selector:
        - '1763811812908'
        - structured_output
        - rxnorm_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval 2
        type: knowledge-retrieval
      height: 89
      id: '1763823618307'
      position:
        x: 4196
        y: 388
      positionAbsolute:
        x: 4196
        y: 388
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - 1VyIxjBR3hsNBjC0dD4LEP9zHsQPphhiT83JBAUVkjUCpjCSL2HCW0L6/6lRdsVs
        multiple_retrieval_config:
          reranking_enable: false
          reranking_mode: reranking_model
          top_k: 4
        query_variable_selector:
        - '1763811812908'
        - structured_output
        - umls_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval 3
        type: knowledge-retrieval
      height: 89
      id: '1763823646400'
      position:
        x: 4196
        y: 518
      positionAbsolute:
        x: 4196
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - cJqqhHn1ho+aIs2NXenlDBu0reoJq+uqqd21Mdz0M8p7n/IkeMY1ZemCtd9mWq9Q
        multiple_retrieval_config:
          reranking_enable: false
          reranking_mode: reranking_model
          top_k: 4
        query_variable_selector:
        - '1763811812908'
        - structured_output
        - openfda_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval 4
        type: knowledge-retrieval
      height: 89
      id: '1763823674800'
      position:
        x: 4196
        y: 648
      positionAbsolute:
        x: 4196
        y: 648
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - XlAYRtQcd39fJJEjyTPXLknYrtzN+zpC/fHq5E71GyMa5fNynKWSkaMia8AZtD72
        multiple_retrieval_config:
          reranking_enable: false
          reranking_mode: reranking_model
          top_k: 4
        query_variable_selector:
        - '1763811812908'
        - structured_output
        - trials_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval 5
        type: knowledge-retrieval
      height: 89
      id: '1763823697319'
      position:
        x: 4196
        y: 778
      positionAbsolute:
        x: 4196
        y: 778
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        selected: false
        template: "{# ======================================\r\n   COMBINED EVIDENCE\
          \ TEMPLATE ‚Äì CLARA MS\r\n   Inputs: user_query, trials_kr, openfda_kr, icd_kr,\
          \ rxnorm_kr, umls_kr\r\n   ====================================== #}\r\n\
          \r\n{# ---------- USER QUERY (optional) ---------- #}\r\n{% if user_query\
          \ is defined and user_query %}\r\n# USER QUERY\r\n{{ user_query }}\r\n\r\
          \n{% endif %}\r\n\r\n{# ---------- ClinicalTrials Evidence ---------- #}\r\
          \n# EVIDENCE ‚Äî ClinicalTrials.gov\r\n\r\n{% set k = trials_kr %}\r\n{% if\
          \ k is mapping and (k.result is defined) %}\r\n  {% set k = k.result %}\r\
          \n{% endif %}\r\n\r\n{% if k is sequence and (k|length) > 0 %}\r\n  {% for\
          \ r in k[:8] %}\r\n    {# metadata shortcut #}\r\n    {% set md  = r.metadata\
          \ | default({}) %}\r\n    {% set dm  = md.doc_metadata if (md is mapping\
          \ and (md.doc_metadata is defined)) else {} %}\r\n\r\n    {# title #}\r\n\
          \    {% set title = r.title\r\n                  | default(dm.brief_title)\r\
          \n                  | default(dm.official_title)\r\n                  |\
          \ default(r.document_name)\r\n                  | default(r.id)\r\n    \
          \              | default('Untitled trial') %}\r\n\r\n    {# NCT id #}\r\n\
          \    {% set nct = dm.nct_id\r\n                | default(md.nct_id)\r\n\
          \                | default('') %}\r\n    {% if not nct and md.url is defined\
          \ and ('NCT' in md.url) %}\r\n      {% set nct = md.url.split('/')[-1] %}\r\
          \n    {% endif %}\r\n    {% if nct and not nct.startswith('NCT') %}\r\n\
          \      {% set nct = 'NCT' ~ nct %}\r\n    {% endif %}\r\n\r\n    {# status\
          \ / phase #}\r\n    {% set status = dm.overall_status | default(md.overall_status)\
          \ | default('') %}\r\n    {% set phase  = dm.phase | default(md.phase) |\
          \ default('') %}\r\n\r\n    {# link #}\r\n    {% set link = dm.source_url\r\
          \n                 | default(md.source_url)\r\n                 | default(dm.path)\r\
          \n                 | default(md.path)\r\n                 | default(r.source)\r\
          \n                 | default(r.url)\r\n                 | default('') %}\r\
          \n\r\n‚Ä¢ {{ title | replace('\\n',' ') }}{% if nct %} [{{ nct }}]{% endif\
          \ %}\r\n  ‚Äî {{ (r.content | default(dm.brief_summary) | default('') | replace('\\\
          n',' '))[:400]\r\n       ~ ('‚Ä¶' if ((r.content | default(dm.brief_summary)\
          \ | default(''))|length > 400) else '') }}\r\n  [{% if link %}{{ link }}{%\
          \ endif %}]{% if status %} ({{ status }}){% endif %}{% if phase %} [Phase:\
          \ {{ phase }}]{% endif %}\r\n  {% endfor %}\r\n{% else %}\r\n‚Ä¢ (no ClinicalTrials\
          \ records)\r\n{% endif %}\r\n\r\n{# ---------- openFDA Evidence ----------\
          \ #}\r\n# EVIDENCE ‚Äî openFDA\r\n\r\n{% set k = openfda_kr %}\r\n{% if k\
          \ is mapping and (k.result is defined) %}\r\n  {% set k = k.result %}\r\n\
          {% endif %}\r\n\r\n{% if k is sequence and (k|length) > 0 %}\r\n  {% for\
          \ r in k[:8] %}\r\n    {% set md = r.metadata | default({}) %}\r\n    {%\
          \ set dm = md.doc_metadata if (md is mapping and (md.doc_metadata is defined))\
          \ else {} %}\r\n\r\n    {% set dataset = dm.dataset | default(md.dataset)\
          \ | default('') %}\r\n    {% set recall  = dm.recall_number | default(md.recall_number)\
          \ | default('') %}\r\n    {% set srs    = dm.safetyreportid | default(md.safetyreportid)\
          \ | default('') %}\r\n    {% set spl    = dm.spl_set_id | default(md.spl_set_id)\
          \ | default('') %}\r\n    {% set link   = dm.openfda_api_url\r\n       \
          \            | default(md.openfda_api_url)\r\n                   | default(dm.source_url)\r\
          \n                   | default(md.source_url)\r\n                   | default(dm.path)\r\
          \n                   | default(md.path)\r\n                   | default(r.source)\r\
          \n                   | default(r.url)\r\n                   | default('')\
          \ %}\r\n    {% set title  = r.title\r\n                   | default(dm.document_title)\r\
          \n                   | default(r.document_name)\r\n                   |\
          \ default(r.id)\r\n                   | default('openFDA record') %}\r\n\
          \r\n‚Ä¢ {{ title | replace('\\n',' ') }}\r\n  ‚Äî {{ (r.content | default(dm.abstract)\
          \ | default('') | replace('\\n',' '))[:400]\r\n       ~ ('‚Ä¶' if ((r.content\
          \ | default(dm.abstract) | default(''))|length > 400) else '') }}\r\n  [{%\
          \ if link %}{{ link }}{% endif %}]{% if dataset %} ({{ dataset }}){% endif\
          \ %}{% if recall %} [Recall: {{ recall }}]{% endif %}{% if srs %} [FAERS:\
          \ {{ srs }}]{% endif %}{% if spl %} [SPL: {{ spl }}]{% endif %}\r\n  {%\
          \ endfor %}\r\n{% else %}\r\n‚Ä¢ (no openFDA records)\r\n{% endif %}\r\n\r\
          \n{# ---------- ICD-11 Evidence ---------- #}\r\n# EVIDENCE ‚Äî ICD-11\r\n\
          \r\n{% set k = icd_kr %}\r\n{% if k is mapping and (k.result is defined)\
          \ %}\r\n  {% set k = k.result %}\r\n{% endif %}\r\n\r\n{% if k is sequence\
          \ and (k|length) > 0 %}\r\n  {% for r in k[:8] %}\r\n    {% set md = r.metadata\
          \ | default({}) %}\r\n    {% set dm = md.doc_metadata if (md is mapping\
          \ and (md.doc_metadata is defined)) else {} %}\r\n\r\n    {% set code  =\
          \ dm.code | default(md.code) | default('') %}\r\n    {% set title = r.title\r\
          \n                  | default(dm.title)\r\n                  | default(r.document_name)\r\
          \n                  | default(r.id)\r\n                  | default('ICD-11\
          \ record') %}\r\n    {% set uri   = dm.uri\r\n                  | default(dm.source_url)\r\
          \n                  | default(md.source_url)\r\n                  | default(dm.path)\r\
          \n                  | default(md.path)\r\n                  | default(r.source)\r\
          \n                  | default(r.url)\r\n                  | default('')\
          \ %}\r\n    {% set defn  = dm.definition | default('') %}\r\n\r\n‚Ä¢ {{ title\
          \ | replace('\\n',' ') }}{% if code %} [ICD-11: {{ code }}]{% endif %}\r\
          \n  ‚Äî {{ (r.content | default(defn) | default('') | replace('\\n',' '))[:400]\r\
          \n       ~ ('‚Ä¶' if ((r.content | default(defn) | default(''))|length > 400)\
          \ else '') }}\r\n  [{% if uri %}{{ uri }}{% endif %}]\r\n  {% endfor %}\r\
          \n{% else %}\r\n‚Ä¢ (no ICD-11 records)\r\n{% endif %}\r\n\r\n{# ----------\
          \ RxNorm / RxClass Evidence ---------- #}\r\n# EVIDENCE ‚Äî RxNorm / RxClass\r\
          \n\r\n{% set k = rxnorm_kr %}\r\n{% if k is mapping and (k.result is defined)\
          \ %}\r\n  {% set k = k.result %}\r\n{% endif %}\r\n\r\n{% if k is sequence\
          \ and (k|length) > 0 %}\r\n  {% for r in k[:8] %}\r\n    {% set md  = r.metadata\
          \ | default({}) %}\r\n    {% set dm  = md.doc_metadata if (md is mapping\
          \ and (md.doc_metadata is defined)) else {} %}\r\n\r\n    {% set rxcui \
          \    = dm.rxcui | default(md.rxcui) | default('') %}\r\n    {% set ndc \
          \      = dm.ndc | default(md.ndc) | default('') %}\r\n    {% set classId\
          \   = dm.classId | default(md.classId) | default('') %}\r\n    {% set className\
          \ = dm.className | default(md.className) | default('') %}\r\n    {% set\
          \ classType = dm.classType | default(md.classType) | default('') %}\r\n\
          \    {% set src       = dm.source_url\r\n                      | default(md.source_url)\r\
          \n                      | default(dm.path)\r\n                      | default(md.path)\r\
          \n                      | default(r.source)\r\n                      | default(r.url)\r\
          \n                      | default('') %}\r\n    {% set title     = r.title\r\
          \n                      | default(dm.document_title)\r\n               \
          \       | default(r.document_name)\r\n                      | default(r.id)\r\
          \n                      | default('RxNorm record') %}\r\n\r\n‚Ä¢ {{ title\
          \ | replace('\\n',' ') }}\r\n  ‚Äî {{ (r.content | default(dm.abstract) |\
          \ default('') | replace('\\n',' '))[:400]\r\n       ~ ('‚Ä¶' if ((r.content\
          \ | default(dm.abstract) | default(''))|length > 400) else '') }}\r\n  [{%\
          \ if src %}{{ src }}{% endif %}]{% if rxcui %} [RxCUI: {{ rxcui }}]{% endif\
          \ %}{% if ndc %} [NDC: {{ ndc }}]{% endif %}{% if classId %} [Class: {{\
          \ classId }}{% if className %} ({{ className }}){% endif %}{% if classType\
          \ %} [{{ classType }}]{% endif %}]{% endif %}\r\n  {% endfor %}\r\n{% else\
          \ %}\r\n‚Ä¢ (no RxNorm/RxClass records)\r\n{% endif %}\r\n\r\n{# ----------\
          \ UMLS Evidence ---------- #}\r\n# EVIDENCE ‚Äî UMLS\r\n\r\n{% set k = umls_kr\
          \ %}\r\n{% if k is mapping and (k.result is defined) %}\r\n  {% set k =\
          \ k.result %}\r\n{% endif %}\r\n\r\n{% if k is sequence and (k|length) >\
          \ 0 %}\r\n  {% for r in k[:8] %}\r\n    {% set md  = r.metadata | default({})\
          \ %}\r\n    {% set dm  = md.doc_metadata if (md is mapping and (md.doc_metadata\
          \ is defined)) else {} %}\r\n\r\n    {% set cui    = dm.cui | default(dm.ui)\
          \ | default(md.cui) | default('') %}\r\n    {% set root   = dm.rootSource\
          \ | default(dm.root_source) | default(md.rootSource) | default('') %}\r\n\
          \    {% set code   = dm.code | default('') %}\r\n    {% set stys   = dm.semanticTypes\
          \ | default(dm.semantic_types) | default([]) %}\r\n    {% set defsrc = dm.definitionSource\
          \ | default(dm.definition_source) | default('') %}\r\n\r\n    {% set src\
          \ = dm.source_url\r\n                | default(md.source_url)\r\n      \
          \          | default(dm.path)\r\n                | default(md.path)\r\n\
          \                | default(r.source)\r\n                | default(r.url)\r\
          \n                | default('') %}\r\n\r\n    {% set title = r.title\r\n\
          \                  | default(dm.name)\r\n                  | default(r.document_name)\r\
          \n                  | default(r.id)\r\n                  | default('UMLS\
          \ record') %}\r\n\r\n‚Ä¢ {{ title | replace('\\n',' ') }}\r\n  ‚Äî {{ (r.content\
          \ | default(dm.definition) | default('') | replace('\\n',' '))[:400]\r\n\
          \       ~ ('‚Ä¶' if ((r.content | default(dm.definition) | default(''))|length\
          \ > 400) else '') }}\r\n  [{% if src %}{{ src }}{% endif %}]{% if cui %}\
          \ [CUI: {{ cui }}]{% endif %}\r\n  {% if root and code %} [{{ root }}: {{\
          \ code }}]{% endif %}\r\n  {% if stys and (stys|length) > 0 %} [STY: {{\
          \ (stys|list)[:3] | join(', ') }}{% if (stys|length) > 3 %}, ‚Ä¶{% endif %}]{%\
          \ endif %}\r\n  {% if defsrc %} [Def: {{ defsrc }}]{% endif %}\r\n  {% endfor\
          \ %}\r\n{% else %}\r\n‚Ä¢ (no UMLS records)\r\n{% endif %}"
        title: Template 4
        type: template-transform
        variables:
        - value_selector:
          - '1763823575062'
          - result
          value_type: array[object]
          variable: icd_kr
        - value_selector:
          - '1763823618307'
          - result
          value_type: array[object]
          variable: rxnorm_kr
        - value_selector:
          - '1763823646400'
          - result
          value_type: array[object]
          variable: umls_kr
        - value_selector:
          - '1763823674800'
          - result
          value_type: array[object]
          variable: openfda_kr
        - value_selector:
          - '1763823697319'
          - result
          value_type: array[object]
          variable: trials_kr
        - value_selector:
          - '1763802945681'
          - text
          value_type: string
          variable: user_query
      height: 51
      id: '1763828512463'
      position:
        x: 4498
        y: 518
      positionAbsolute:
        x: 4498
        y: 518
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -1268.9524917570122
      y: -12.820869331440065
      zoom: 0.49863682122110253
  rag_pipeline_variables: []
